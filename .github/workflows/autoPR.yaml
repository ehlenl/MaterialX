name: Create Branch and PR

on:
  workflow_dispatch:  # This allows for manual triggering.
  schedule:
    - cron: '0 0 * * 6'  # This sets the workflow to run every Saturday at midnight.

jobs:
  create-branch-and-pr:
    runs-on: ubuntu-latest
    env:
      MERGE_BRANCH: adsk-merge-branch

    steps:
    - name: Checkout main branch
      uses: actions/checkout@v2
      with:
        ref: main

    - name: Merge into existing branch
      run: | 
        # Check if the merge branch already exist
        if git ls-remote --heads origin refs/heads/$MERGE_BRANCH; then
            echo "Merge main into the existing $MERGE_BRANCH"
            git merge main
        else
            echo "Create new branch $MERGE_BRANCH"
            git checkout -b $MERGE_BRANCH
            
        fi
        git push origin $MERGE_BRANCH    

    - name: Create pull request to adsk_contrib/dev
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh pr create \
        --title "Merge $MERGE_BRANCH into adsk_contrib/dev" \
        --body "Auto-created PR to merge $MERGE_BRANCH into adsk_contrib/dev" \
        --head $MERGE_BRANCH \
        --base adsk_contrib/dev \
        --reviewer "ehlenl"
